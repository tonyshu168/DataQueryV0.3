angular.module("dataQuery",["ng"]).controller("mainCtrl",["$scope","rootScope","$http","$interval","$timeout",function(j,g,f,e,c){j.change=function(){$("#changePwd").show(500)};j.resetPwd=function(){$("#resetPwd").show(500)};j.$watch("uname",function(){g.uname=j.uname});j.close=function(){$("#changePwd").hide(500)};j.closeAlert=function(){$("#selectAlert").fadeOut(500)};j.refresh=function(){if(j.uname!="apy"){f.get("data/getProducts.php?name="+g.uname).success(function(k){j.arrSort(k,"effectiveDate");j.products=k})}else{f.get("data/getAllProducts.php").success(function(k){j.arrSort(k,"effectiveDate");j.products=k})}j.clearSearchHistroy()};console.log(j.effectiveDate);console.log(j.endDate);j.search=function(){if(g.uname=="apy"){if(j.productName||j.channelNum||j.company||j.coopType||j.effectiveDate||j.endDate){b();var m="productName="+j.productName+"&channelNum="+j.channelNum+"&company="+j.company+"&cooperateType="+j.coopType+"&effectiveDate="+(j.effectiveDate?j.effectiveDate.getTime():"")+"&endDate="+(j.endDate?j.endDate.getTime():"");f.get("data/newSelectDataV2.php?"+m).success(function(n){j.arrSort(n,"effectiveDate");j.products=n;if(!n.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}console.log(j.effectiveDate);console.log(j.endDate)}else{if(j.productName||j.channelNum||j.company||j.cooperateType||j.effectiveDate||j.endDate){if(j.effectiveDate){var l=j.effectiveDate.getTime()}else{var l=""}if(j.endDate){var k=j.endDate.getTime()}else{var k=""}b();var m=j.productName+"&channelNum="+j.channelNum+"&company="+j.company+"&cooperateType="+j.coopType+"&uname="+j.uname+"&effectiveDate="+l+"&endDate="+k;f.get("data/newSelectData_self.php?productName="+m).success(function(n){j.arrSort(n,"effectiveDate");j.products=n;if(!n.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}}};function b(){if(!j.productName){j.productName=""}if(!j.channelNum){j.channelNum=""}if(!j.company){j.company=""}if(!j.coopType){j.coopType=""}}j.addRows=function(){if(g.uname=="apy"){$("#editContent").show(500)}};j.jumpPage=function(k){window.open("editBack02.html?"+k)};j.index=0;j.openEditWindow=function(){j.index=this.$index;$("#editContent").show(500)};j.inputProductInfo=function(){$("#inputProductInfo").show(500)};j.delRow=function(){console.log(this.$index);if(confirm){j.products.splice(this.$index,1)}};j.reverseArr=function(){j.products.reverse()};function i(k){$.each(k,function(l){k[l].effectiveDate=new Date(k[l].effectiveDate)})}j.changeDate=function(l){var k=new Date(l*1);return k.toLocaleDateString().replace(/\//g,"-")};j.arrSort=function(o,n){for(var m=1;m<o.length;m++){for(var l=0,k={};l<o.length-m;l++){if(o[l][n]*1<o[l+1][n]*1){k=o[l];o[l]=o[l+1];o[l+1]=k}}}};var d={};$("#table-data").on("click","[sort-by]",function(l){var k=$(this).attr("sort-by");d[k]=d[k]||0;d[k]++;var m=d[k]%2;j.products.sort(function(o,n){if(k=="installCount"||k=="price"){return m?o[k]-n[k]:n[k]-o[k]}else{return m?o[k].localeCompare(n[k]):n[k].localeCompare(o[k])}});j.$apply()});$("#searchAppend").on("input",function(){j.products.forEach(function(l,k){l.isHide=false});$(this).find("[filter]").each(function(){var k=$(this).attr("filter");var l=this.value;j.products.forEach(function(n,m){n.isHide=n.isHide||(l&&(n.isHide=(n[k]||"").toLowerCase()!=(l||"").toLowerCase()))})});j.$apply()});e(function(){if(j.uname!="apy"){console.log(j.uname);f.get("data/getProducts.php?name="+g.uname).success(function(k){j.arrSort(k,"effectiveDate");j.products=k;g.products=j.products});$("#addEdit").css("display","none")}else{f.get("data/getAllProducts.php").success(function(k){j.arrSort(k,"effectiveDate");j.products=k;g.products=j.products})}j.$apply()},1000*3600*2);j.editable=true;j.autoComplete="off";var a=[];j.changeDis=function(){j.editable=false;j.autocomplete="on"};j.saveEditData=function(k){if(j.editable==false){var l=/\d/g;if(l.test(j.products[k].installCount)){f.get("data/saveInstallCount.php?installCount="+j.products[k].installCount+"&did="+j.products[k].did).success(function(o){var p=$("#table-data tbody tr").eq(k);if(o=="Update Succ!"){console.log("修改成功");var n=p.css("background");p.css("background","#81E3D6");c(function(){p.css("background",n)},5000)}else{var m=p.css("color");p.css("color","#f00");c(function(){p.css("color",m);j.abandon(k)},5000)}})}else{console.log("输入的必须为数字!!")}}};j.abandon=function(k){if(!j.editable){console.log(k);console.log(j.products[k].did);console.log(j.products,a);console.log(j.products.length,a.length);var m=j.products[k].did;var l=h(m,a);console.log(l);console.log(a[l].installCount);j.products[k].installCount=a[l].installCount;j.editable=true}};function h(l,m){for(var k=0;k<m.length;k++){console.log(m[k].did);if(m[k].did==l){return k}}}j.clearSearchHistroy=function(){console.log("clear");j.productName="";j.channelNum="";j.cooperateType="";j.company="";j.effectiveDate="";j.endDate=""}}]).controller("login",["$scope","$http","$rootScope",function(c,e,a){c.show=true;if(localStorage.uname){d()}c.verification=function(){e.get("data/verificationUserPwd.php?uname="+c.uname+"&pwd="+c.pwd).success(function(f){if(f!="login succ!"){c.show=false}else{if(c.select==true){b(c.uname,c.pwd)}$("#login-container").hide(500);a.uname=c.uname;if(c.uname!="apy"){console.log(c.uname);$("#self_company").hide();$("#other_user").show();e.get("data/getProducts.php?name="+a.uname).success(function(g){c.arrSort(g,"effectiveDate");c.products=g;a.products=c.products});$("#addEdit").css("display","none")}else{e.get("data/getAllProducts.php").success(function(g){console.log("getData");c.arrSort(g,"effectiveDate");c.products=g;a.products=c.products})}}})};function b(f,g){window.localStorage.uname=f;window.localStorage.pwd=g;window.localStorage.loginTime=new Date().getTime()}function d(){var g=localStorage.uname;var i=localStorage.pwd;var f=localStorage.loginTime;var h=new Date().getTime();if((h-f)>1000*3600*24*7){localStorage.removeItem("uname");localStorage.removeItem("pwd")}else{c.uname=g;c.pwd=i}}}]).controller("changePwd",["$scope","$rootScope","$http",function(c,a,d){c.pwdAlert=true;c.oldPwdAlert="hidden";var b=true;c.$watch("uname",function(){console.log(c.uname)});c.verificationOldPwd=function(){if(c.pwd){d.get("data/verificationUserPwd.php?uname="+c.uname+"&pwd="+c.pwd).success(function(e){console.log(e);if(e!="login succ!"){c.oldPwdAlert="visible";b=false}else{c.oldPwdAlert="hidden"}})}};c.checkIpntPwd=function(){if(c.firstPwd!=c.secondPwd){c.pwdAlert=false}else{if(c.firstPwd.length>=6&&b){d.get("data/changePwd.php?uname="+c.uname+"&pwd="+c.secondPwd).success(function(e){console.log(e)});$("#changePwd").hide(500);c.clearAllPwd()}}};c.clearAllPwd=function(){c.pwd="";c.firstPwd="";c.secondPwd=""}}]).controller("editContent",["$scope","$rootScope","$rootScope",function(c,a,e){c.isShow="hidden";c.firstInsertIndex=[];c.newAddData=[];c.save=function(){var f={};console.log(c.cooperateType);d();if(c.productName&&c.channelNum&&c.company&&c.compAbbreviation&&c.cooperateType&&c.price&&c.effectiveDate&&c.endDate){if((c.effectiveDate.getTime()+1000*3600*24*365)<=c.endDate.getTime()&&/\d/g.test(parseInt(c.price))){e.get("data/insertData02.php?proName="+c.productName+"&channelName="+c.channelNum+"&company="+c.company+"&compabbr="+c.compAbbreviation+"&coopType="+c.cooperateType+"&price="+c.price+"&effeDate="+c.effectiveDate.getTime()+"&endDate="+c.endDate.getTime()).success(function(g){console.log(g);if(g.msg=="Insert Succ!"){c.isShow="visible";c.insertMsg="输入成功!!!";c.firstInsertIndex.push(g.did);e.get("data/returnNewAdd.php?did="+g.did).success(function(h){console.log(h);c.newAddData.push(h);c.products=c.newAddData})}else{c.isShow="visible";c.insertMsg="输入有误!!!"}})}else{c.isShow="visible";c.insertMsg="输入有误或格式不对!!"}}};c.close=function(){$("#editContent").hide(500)};function d(){switch(c.cooperateType){case"0":c.cooperateType="CPA";break;case"1":c.cooperateType="CPC";break;case"2":c.cooperateType="CPI";break;case"3":c.cooperateType="CPT";break}}function b(){var f=new Date();f.setFullYear(f.getFullYear()+1);c.endDate=f}b()}]).controller("editBack",["$scope","$rootScope","$http",function(l,j,g){var h={};h.productName=[];h.channelNum=[];h.company=[];h.compAbbreviation=[];var c=l;c.isVisi="hidden";c.dateShow="hidden";c.close=function(){$("#inputProductInfo").hide(500);k()};c.verifiedDate=function(){var n=new Date(c.effectiveDate);if(c.effectiveDate){c.endDate=c.effectiveDate;c.endDate.setFullYear(c.effectiveDate.getFullYear()+1)}c.isVisi="hidden"};c.checkDate=function(){var n=new Date(c.effectiveDate);var o=new Date(c.endDate);c.effectiveDate&&(c.effectiveDate=n.getTime());c.endDate&&(c.endDate=o.getTime());c.isVisi="hidden";if(o.getTime()<(n.getTime()+1000*3600*24*365)){console.log(o.getTime());c.dateShow="visible";c.dateMsg="结束日期必须大于生效日期+1年"}else{c.dateShow="hidden";c.dateMsg=""}c.effectiveDate=n.toLocaleDateString().replace(/\//g,"-");c.endDate=o.toLocaleDateString().replace(/\//g,"-")};var b=false;c.veriPrice="hidden";c.verifiedPrice=function(){if(c.price){b=/^^(\d)*(.)?(\d)*$/.test(c.price);if(!b){c.veriPrice="visible";c.priceAlert="单价必须为数字!!"}else{c.veriPrice="hidden";c.priceAlert=""}}console.log(b)};var d=false;c.verifiedInstall=function(){if(c.installCount){installMsg=/^(\d)*$/.test(c.installCount);if(!installMsg){c.isVisi="visible";c.isSucc="安装量必须为数字或整数"}else{c.isVisi="hidden";c.isSucc=""}}};l.firstInsertIndex=[];l.newAddData=[];var a=[];c.save=function(){var n={};m();if(l.productName&&l.channelNum&&l.company&&l.compAbbreviation&&l.cooperateType&&b&&installMsg&&c.effectiveDate){g.get("data/insertDataAll.php?proName="+l.productName+"&channelName="+l.channelNum+"&company="+l.company+"&compabbr="+l.compAbbreviation+"&coopType="+l.cooperateType+"&price="+l.price+"&installCount="+l.installCount+"&effeDate="+l.effectiveDate.getTime()+"&endDate="+l.endDate.getTime()).success(function(o){console.log(o);if(o.msg=="Insert Succ!"){c.isVisi="visible";l.isSucc="输入成功!!!";l.firstInsertIndex.push(o.did);g.get("data/returnNewAdd.php?did="+o.did).success(function(p){console.log(p);l.newAddData.push(p);l.arrSort(l.newAddData,"effectiveDate");l.products=l.newAddData;a.concat(l.newAddData);a.push(p)});l.saveInputProductInfo()}else{l.isVisi="visible";l.isSucc="输入有误!!!"}})}else{l.isVisi="visible";l.isSucc="漏输入或输入有误或格式不对!!"}l.clearSearchHistroy()};function k(){l.productName="";l.channelNum="";l.company="";l.compAbbreviation="";l.price="";l.installCount=""}l.saveInputProductInfo=function(){var n=localStorage.products?JSON.parse(localStorage.products):"";if(!n.productName||n.productName.length<8){h.productName.push(l.productName)}if(!n.channelNum||n.channelNum.length<8){h.channelNum.push(l.channelNum)}if(!n.company||n.company.length<8){h.company.push(l.company)}if(!n.compAbbreviation||n.compAbbreviation.length<8){h.compAbbreviation.push(l.compAbbreviation)}localStorage.products=JSON.stringify(h)};l.autoAppendKW=function(){if(localStorage.products){var n="";l.$watch("productName",function(){console.log(l.productName);var q=JSON.parse(localStorage.products);console.log(q);console.log(q.productName);var r=q.productName;for(var p in r){if(r[p].indexOf(l.productName)>=0){console.log(r[p]);n+="<li>"+r[p]+"</li>"}}var o=$("input[ng-model='productName']");o.next().html(n);o.next().show();o.next().children().on("click",function(){l.productName=this.innerHTML;this.parentElement.innerHTML="";$(this).parent().hide();l.$apply()})})}};document.querySelector("#inputProductInfo").addEventListener("click",function(){$("input[ng-model='productName']").next().hide()});function i(){c.effectiveDate=new Date()}i();function e(){var n=new Date();n.setFullYear(n.getFullYear()+1);c.endDate=n}e();function f(p){var n=new Date(p);var o=n.setFullYear(n.getFullYear()+1);return o}function m(){switch(l.cooperateType){case"0":l.cooperateType="CPA";break;case"1":l.cooperateType="CPC";break;case"2":l.cooperateType="CPI";break;case"3":l.cooperateType="CPT";break}}}]).controller("editData",["$scope","$rootScope","$http","$timeout",function(k,i,g,c){var a=[];var m=location.href;m.lastIndexOf("?")>=0&&(k.uname=m.substring(location.href.lastIndexOf("?")+1));k.editable=true;k.autoComplete="off";if(k.uname!="apy"){console.log(k.uname);g.get("data/getProducts.php?name="+i.uname).success(function(n){k.arrSort(n,"effectiveDate");k.products=n;i.products=k.products})}else{g.get("data/getAllProducts.php").success(function(n){k.arrSort(n,"effectiveDate");k.products=n;i.products=k.products;a=k.products})}e();k.changeDis=function(){k.editable=false;k.autocomplete="on"};k.refresh=function(){k.clearSearchHistroy();e()};function e(){if(k.uname!="apy"){console.log(k.uname);g.get("data/getProducts.php?name="+i.uname).success(function(n){i.arrSort(n,"effectiveDate");k.products=n;i.products=k.products})}else{g.get("data/getAllProducts.php").success(function(n){k.arrSort(n,"effectiveDate");k.products=n;i.products=k.products})}}var d={};$("#table-data").on("click","[sort-by]",function(o){var n=$(this).attr("sort-by");d[n]=d[n]||0;d[n]++;var p=d[n]%2;k.products.sort(function(r,q){if(n=="installCount"||n=="price"){return p?r[n]-q[n]:q[n]-r[n]}else{return p?r[n].localeCompare(q[n]):q[n].localeCompare(r[n])}});k.$apply()});k.searchData=function(){if(k.productName||k.channelNum||k.company||k.cooperateType){b();console.log(k.productName);var n="productName="+k.productName+"&channelNum="+k.channelNum+"&company="+k.company+"&cooperateType="+k.cooperateType;g.get("data/newSelectData.php?"+n).success(function(o){console.log(o);k.products=o;if(!o.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}};function b(){if(!k.productName){k.productName=""}if(!k.channelNum){k.channelNum=""}if(!k.company){k.company=""}if(!k.cooperateType){k.cooperateType=""}}k.saveEditData=function(n){if(k.editable==false&&k.cooperateVerified&&k.priceVerified){var o=k.products[n].productName+"&channelNum="+k.products[n].channelNum+"&cooperateType="+k.products[n].cooperateType.toUpperCase()+"&company="+k.products[n].company+"&price="+k.products[n].price+"&did="+k.products[n].did;g.get("data/saveEdit_Table.php?productName="+o).success(function(r){var s=$("#table-data tbody tr").eq(n);if(r=="Update Succ!"){console.log("修改成功");var q=s.css("background");s.css("background","#81E3D6");c(function(){s.css("background",q)},5000)}else{var p=s.css("color");s.css("color","#f00");c(function(){s.css("color",p);k.abandon(n)},5000)}})}};k.verifiedCooperate=function(n){var o=["CPA","CPC","CPI","CPT"];if(o.indexOf(k.products[n].cooperateType.toUpperCase())<0){k.verifiedDataMsg="合作类型只能从:CPA,CPC,CPI,CPT中选择一种.";$("#verifiedData").show(500)}else{k.cooperateVerified=true}};k.verifiedPrice=function(n){if(!/\d/g.test(k.products[n].price)){k.verifiedDataMsg="输入的数据类型不对.";$("#verifiedData").show(500)}else{k.priceVerified=true}};k.closeVerifiedData=function(){$("#verifiedData").hide(500)};k.abandon=function(n){if(!k.editable){console.log(n);console.log(k.products[n].did);console.log(k.products,a);console.log(k.products.length,a.length);var p=k.products[n].did;var o=j(p,a);console.log(o);console.log(a[o].installCount);k.products[n].installCount=a[o].installCount;k.editable=true}};function j(o,p){for(var n=0;n<p.length;n++){console.log(p[n].did);if(p[n].did==o){return n}}}k.isShow="hidden";k.firstInsertIndex=[];k.newAddData=[];k.save=function(){var n={};console.log(k.cooperateType);l();if(k.productName&&k.channelNum&&k.company&&k.compAbbreviation&&k.cooperateType&&k.price&&k.effectiveDate&&k.endDate){if((k.effectiveDate.getTime()+1000*3600*24*365)<=k.endDate.getTime()&&/\d/g.test(parseInt(k.price))){g.get("data/insertData02.php?proName="+k.productName+"&channelName="+k.channelNum+"&company="+k.company+"&compabbr="+k.compAbbreviation+"&coopType="+k.cooperateType+"&price="+k.price+"&effeDate="+k.effectiveDate.getTime()+"&endDate="+k.endDate.getTime()).success(function(o){console.log(o);if(o.msg=="Insert Succ!"){k.isShow="visible";k.insertMsg="输入成功!!!";k.firstInsertIndex.push(o.did);g.get("data/returnNewAdd.php?did="+o.did).success(function(p){console.log(p);k.newAddData.push(p);k.arrSort(k.newAddData,"effectiveDate");k.products=k.newAddData;a.concat(k.newAddData);a.push(p);console.log(a,a.length)})}else{k.isShow="visible";k.insertMsg="输入有误!!!"}})}else{k.isShow="visible";k.insertMsg="输入有误或格式不对!!"}}else{k.isShow="visible";k.insertMsg="漏输入或输入有误或格式不对!!"}k.clearSearchHistroy()};k.close=function(){$("#editContent").hide(500);k.clearSearchHistroy()};function l(){switch(k.cooperateType){case"0":k.cooperateType="CPA";break;case"1":k.cooperateType="CPC";break;case"2":k.cooperateType="CPI";break;case"3":k.cooperateType="CPT";break}}function h(){k.effectiveDate=new Date()}h();function f(){var n=new Date();n.setFullYear(n.getFullYear()+1);k.endDate=n}f();k.clearSearchHistroy=function(){k.productName="";k.channelNum="";k.cooperateType="";k.company="";k.compAbbreviation="";k.price=""}}]).controller("resetPwd",["$scope","$http",function(a,b){a.pwdAlert=true;a.isUser="hidden";a.resetSucc="hidden";a.$watch("uname",function(){console.log(a.uname)});a.close=function(){$("#resetPwd").hide(500)};a.checkIsUser=function(){var c=/^[a-zA-Z0-9]+?/;console.log(c.test(a.uname));if(c.test(a.uname)){console.log(a.uname);b.get("data/checkIsUser.php?uname="+a.uname).success(function(d){console.log(d);if(d=="user is being"){a.isUser="hidden";a.isUserMsg=""}else{a.isUser="visible";a.isUserMsg="该用户不存在!!请重新输入"}})}else{a.isUser="visible";a.isUserMsg="用户名不能包含汉字"}};a.checkIpntPwd=function(){console.log(a.isUserMsg);if(a.firstPwd!=a.secondPwd){a.pwdAlert=false}else{if(a.firstPwd.length>=6&&a.isUserMsg==""){b.get("data/changePwd.php?uname="+a.uname+"&pwd="+a.secondPwd).success(function(c){console.log(c)});a.resetSucc="visible";a.resetSuccess="密码更改成功!!!";a.clearAllPwd()}}};a.changeResetmsg=function(){a.resetSuccess=""};a.clearAllPwd=function(){a.firstPwd="";a.secondPwd=""}}]);