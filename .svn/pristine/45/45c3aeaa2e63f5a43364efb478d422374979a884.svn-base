angular.module("dataQuery",["ng"]).controller("mainCtrl",["$scope","$rootScope","$http","$interval","$timeout",function(i,f,e,d,b){i.change=function(){$("#changePwd").show(500)};i.resetPwd=function(){$("#resetPwd").show(500)};i.$watch("uname",function(){f.uname=i.uname});i.close=function(){$("#changePwd").hide(500)};i.closeAlert=function(){$("#selectAlert").fadeOut(500)};i.refresh=function(){if(i.uname!="apy"){e.get("data/getProducts.php?name="+f.uname).success(function(j){i.arrSort(j,"effectiveDate");i.products=j;f.total=i.getInstallTotal(i.products)})}else{e.get("data/getAllProducts.php").success(function(j){i.arrSort(j,"effectiveDate");i.products=j;$socpe.total=i.getInstallTotal(i.products)})}i.clearSearchHistroy()};i.search=function(){if(f.uname=="apy"){if(i.productName||i.channelNum||i.company||i.coopType||i.effectiveDate||i.endDate){a();var l="productName="+i.productName+"&channelNum="+i.channelNum+"&company="+i.company+"&cooperateType="+i.coopType+"&effectiveDate="+(i.effectiveDate?i.effectiveDate.getTime():"")+"&endDate="+(i.endDate?i.endDate.getTime():"");e.get("data/newSelectDataV2.php?"+l).success(function(m){i.arrSort(m,"effectiveDate");i.products=m;$socpe.total=i.getInstallTotal(i.products);if(!m.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}}else{if(i.productName||i.channelNum||i.company||i.cooperateType||i.effectiveDate||i.endDate){if(i.effectiveDate){var k=i.effectiveDate.getTime()}else{var k=""}if(i.endDate){var j=i.endDate.getTime()}else{var j=""}a();var l=i.productName+"&channelNum="+i.channelNum+"&company="+i.company+"&cooperateType="+i.coopType+"&uname="+i.uname+"&effectiveDate="+k+"&endDate="+j;e.get("data/newSelectData_self.php?productName="+l).success(function(m){i.arrSort(m,"effectiveDate");i.products=m;f.total=i.getInstallTotal(i.products);if(!m.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}}};function a(){if(!i.productName){i.productName=""}if(!i.channelNum){i.channelNum=""}if(!i.company){i.company=""}if(!i.coopType){i.coopType=""}}i.addRows=function(){if(f.uname=="apy"){$("#editContent").show(500)}};i.jumpPage=function(j){window.open("editBack02.html?"+j)};i.index=0;i.openEditWindow=function(){i.index=this.$index;$("#editContent").show(500)};i.inputProductInfo=function(){$("#inputProductInfo").show(500)};i.delRow=function(){console.log(this.$index);if(confirm){i.products.splice(this.$index,1)}};i.reverseArr=function(){i.products.reverse()};function h(j){$.each(j,function(k){j[k].effectiveDate=new Date(j[k].effectiveDate)})}i.changeDate=function(k){var j=new Date(k*1);return j.toLocaleDateString().replace(/\//g,"-")};i.arrSort=function(o,n){for(var m=1;m<o.length;m++){for(var l=0,k={};l<o.length-m;l++){if(o[l][n]*1<o[l+1][n]*1){k=o[l];o[l]=o[l+1];o[l+1]=k}}}};var c={};$("#table-data").on("click","[sort-by]",function(k){var j=$(this).attr("sort-by");c[j]=c[j]||0;c[j]++;var l=c[j]%2;i.products.sort(function(n,m){if(j=="installCount"||j=="price"){return l?n[j]-m[j]:m[j]-n[j]}else{return l?n[j].localeCompare(m[j]):m[j].localeCompare(n[j])}});i.$apply()});$("#searchAppend").on("input",function(){i.products.forEach(function(k,j){k.isHide=false});$(this).find("[filter]").each(function(){var j=$(this).attr("filter");var k=this.value;i.products.forEach(function(m,l){m.isHide=m.isHide||(k&&(m.isHide=(m[j]||"").toLowerCase()!=(k||"").toLowerCase()))})});i.$apply()});d(function(){if(i.uname!="apy"){console.log(i.uname);e.get("data/getProducts.php?name="+f.uname).success(function(j){i.arrSort(j,"effectiveDate");i.products=j;f.products=i.products;f.total=i.getInstallTotal(i.products)});$("#addEdit").css("display","none")}else{e.get("data/getAllProducts.php").success(function(j){i.arrSort(j,"effectiveDate");i.products=j;f.products=i.products;$socpe.total=i.getInstallTotal(i.products)})}i.$apply()},1000*3600*2);i.editable=true;i.autoComplete="off";f.oldProducts=[];i.changeDis=function(){i.oldInstallCount=parseInt(this.data.installCount);i.editable=false;i.autocomplete="on"};i.saveEditData=function(j){if(i.editable==false){var k=/\d/g;if(k.test(i.products[j].installCount)){e.get("data/saveInstallCountV2.php?installCount="+i.products[j].installCount+"&productName="+i.products[j].productName+"&channelNum="+i.products[j].channelNum+"&company="+i.products[j].company+"&price="+i.products[j].price+"&did="+i.products[j].did).success(function(n){var o=$("#table-data tbody tr").eq(j);if(n=="Update Succ!"){console.log("修改成功");var m=o.css("background");o.css("background","#81E3D6");b(function(){o.css("background",m)},5000);i.total+=parseInt(i.products[j].installCount)-i.oldInstallCount}else{var l=o.css("color");o.css("color","#f00");b(function(){o.css("color",l);i.abandon(j)},5000)}})}else{console.log("输入的必须为数字!!")}}};i.abandon=function(j){if(!i.editable){var l=i.products[j].did;var k=g(l,i.oldProducts);i.products[j].installCount=f.oldProducts[k].installCount}};function g(k,l){for(var j=0;j<l.length;j++){if(l[j].did==k){return j}}}i.clearSearchHistroy=function(){console.log("clear");i.productName="";i.channelNum="";i.cooperateType="";i.company="";i.effectiveDate="";i.endDate=""};i.getInstallTotal=function(l){console.log(l);var k=null;for(var j=0;j<l.length;j++){k+=parseInt(l[j].installCount)}return k}}]).controller("login",["$scope","$http","$rootScope",function(c,e,a){c.show=true;if(localStorage.uname){d()}c.verification=function(){e.get("data/verificationUserPwd.php?uname="+c.uname+"&pwd="+c.pwd).success(function(f){if(f!="login succ!"){c.show=false}else{if(c.select==true){b(c.uname,c.pwd)}$("#login-container").hide(500);a.uname=c.uname;if(c.uname!="apy"){console.log(c.uname);$("#self_company").hide();$("#other_user").show();e.get("data/getProducts.php?name="+a.uname).success(function(g){c.arrSort(g,"effectiveDate");c.products=g;a.products=c.products;a.total=c.getInstallTotal(c.products)});$("#addEdit").css("display","none")}else{e.get("data/getAllProducts.php").success(function(j){console.log("getData");c.arrSort(j,"effectiveDate");c.products=j;a.products=c.products;$socpe.total=c.getInstallTotal(c.products);for(var h=0;h<c.products.length;h++){a.oldProducts[h]={};for(var g in c.products[h]){a.oldProducts[h][g]=c.products[h][g]}}})}}})};function b(f,g){window.localStorage.uname=f;window.localStorage.pwd=g;window.localStorage.loginTime=new Date().getTime()}function d(){var g=localStorage.uname;var i=localStorage.pwd;var f=localStorage.loginTime;var h=new Date().getTime();if((h-f)>1000*3600*24*7){localStorage.removeItem("uname");localStorage.removeItem("pwd")}else{c.uname=g;c.pwd=i}}}]).controller("changePwd",["$scope","$rootScope","$http",function(c,a,d){c.pwdAlert=true;c.oldPwdAlert="hidden";var b=true;c.$watch("uname",function(){console.log(c.uname)});c.verificationOldPwd=function(){if(c.pwd){d.get("data/verificationUserPwd.php?uname="+c.uname+"&pwd="+c.pwd).success(function(e){console.log(e);if(e!="login succ!"){c.oldPwdAlert="visible";b=false}else{c.oldPwdAlert="hidden"}})}};c.checkIpntPwd=function(){if(c.firstPwd!=c.secondPwd){c.pwdAlert=false}else{if(c.firstPwd.length>=6&&b){d.get("data/changePwd.php?uname="+c.uname+"&pwd="+c.secondPwd).success(function(e){console.log(e)});$("#changePwd").hide(500);c.clearAllPwd()}}};c.clearAllPwd=function(){c.pwd="";c.firstPwd="";c.secondPwd=""}}]).controller("editContent",["$scope","$rootScope","$http",function(c,a,e){c.isShow="hidden";c.firstInsertIndex=[];c.newAddData=[];c.save=function(){var f={};console.log(c.cooperateType);d();if(c.productName&&c.channelNum&&c.company&&c.compAbbreviation&&c.cooperateType&&c.price&&c.effectiveDate&&c.endDate){if((c.effectiveDate.getTime()+1000*3600*24*365)<=c.endDate.getTime()&&/\d/g.test(parseInt(c.price))){e.get("data/insertData02.php?proName="+c.productName+"&channelName="+c.channelNum+"&company="+c.company+"&compabbr="+c.compAbbreviation+"&coopType="+c.cooperateType+"&price="+c.price+"&effeDate="+c.effectiveDate.getTime()+"&endDate="+c.endDate.getTime()).success(function(g){console.log(g);if(g.msg=="Insert Succ!"){c.isShow="visible";c.insertMsg="输入成功!!!";c.firstInsertIndex.push(g.did);e.get("data/returnNewAdd.php?did="+g.did).success(function(h){console.log(h);c.newAddData.push(h);c.products=c.newAddData})}else{c.isShow="visible";c.insertMsg="输入有误!!!"}})}else{c.isShow="visible";c.insertMsg="输入有误或格式不对!!"}}};c.close=function(){$("#editContent").hide(500)};function d(){switch(c.cooperateType){case"0":c.cooperateType="CPA";break;case"1":c.cooperateType="CPC";break;case"2":c.cooperateType="CPI";break;case"3":c.cooperateType="CPT";break}}function b(){var f=new Date();f.setFullYear(f.getFullYear()+1);c.endDate=f}b()}]).controller("editBack",["$scope","$rootScope","$http",function(l,j,g){var h={};h.productName=[];h.channelNum=[];h.company=[];h.compAbbreviation=[];var c=l;c.isVisi="hidden";c.dateShow="hidden";c.close=function(){$("#inputProductInfo").hide(500);k()};c.verifiedDate=function(){var n=new Date(c.effectiveDate);if(c.effectiveDate){c.endDate=c.effectiveDate;c.endDate.setFullYear(c.effectiveDate.getFullYear()+1)}c.isVisi="hidden"};c.checkDate=function(){var n=new Date(c.effectiveDate);var o=new Date(c.endDate);c.effectiveDate&&(c.effectiveDate=n.getTime());c.endDate&&(c.endDate=o.getTime());c.isVisi="hidden";if(o.getTime()<(n.getTime()+1000*3600*24*365)){console.log(o.getTime());c.dateShow="visible";c.dateMsg="结束日期必须大于生效日期+1年"}else{c.dateShow="hidden";c.dateMsg=""}c.effectiveDate=n.toLocaleDateString().replace(/\//g,"-");c.endDate=o.toLocaleDateString().replace(/\//g,"-")};var b=false;c.veriPrice="hidden";c.verifiedPrice=function(){if(c.price){b=/^^(\d)*(.)?(\d)*$/.test(c.price);if(!b){c.veriPrice="visible";c.priceAlert="单价必须为数字!!"}else{c.veriPrice="hidden";c.priceAlert=""}}console.log(b)};var d=false;c.verifiedInstall=function(){if(c.installCount){installMsg=/^(\d)*$/.test(c.installCount);if(!installMsg){c.isVisi="visible";c.isSucc="安装量必须为数字或整数"}else{c.isVisi="hidden";c.isSucc=""}}};l.firstInsertIndex=[];l.newAddData=[];var a=[];c.save=function(){var n={};m();if(l.productName&&l.channelNum&&l.company&&l.compAbbreviation&&l.cooperateType&&b&&installMsg&&c.effectiveDate){g.get("data/insertDataAll.php?proName="+l.productName+"&channelName="+l.channelNum+"&company="+l.company+"&compabbr="+l.compAbbreviation+"&coopType="+l.cooperateType+"&price="+l.price+"&installCount="+l.installCount+"&effeDate="+l.effectiveDate.getTime()+"&endDate="+l.endDate.getTime()).success(function(o){console.log(o);if(o.msg=="Insert Succ!"){c.isVisi="visible";l.isSucc="输入成功!!!";l.firstInsertIndex.push(o.did);g.get("data/returnNewAdd.php?did="+o.did).success(function(p){console.log(p);l.newAddData.push(p);l.arrSort(l.newAddData,"effectiveDate");l.products=l.newAddData;a.concat(l.newAddData);a.push(p)});l.saveInputProductInfo()}else{l.isVisi="visible";l.isSucc="输入有误!!!"}})}else{l.isVisi="visible";l.isSucc="漏输入或输入有误或格式不对!!"}l.clearSearchHistroy()};function k(){l.productName="";l.channelNum="";l.company="";l.compAbbreviation="";l.price="";l.installCount=""}l.saveInputProductInfo=function(){var n=localStorage.products?JSON.parse(localStorage.products):"";if(!n.productName||n.productName.length<8){h.productName.push(l.productName)}if(!n.channelNum||n.channelNum.length<8){h.channelNum.push(l.channelNum)}if(!n.company||n.company.length<8){h.company.push(l.company)}if(!n.compAbbreviation||n.compAbbreviation.length<8){h.compAbbreviation.push(l.compAbbreviation)}localStorage.products=JSON.stringify(h)};l.autoAppendKW=function(){if(localStorage.products){var n="";l.$watch("productName",function(){console.log(l.productName);var q=JSON.parse(localStorage.products);console.log(q);console.log(q.productName);var r=q.productName;for(var p in r){if(r[p].indexOf(l.productName)>=0){console.log(r[p]);n+="<li>"+r[p]+"</li>"}}var o=$("input[ng-model='productName']");o.next().html(n);o.next().show();o.next().children().on("click",function(){l.productName=this.innerHTML;this.parentElement.innerHTML="";$(this).parent().hide();l.$apply()})})}};document.querySelector("#inputProductInfo").addEventListener("click",function(){$("input[ng-model='productName']").next().hide()});function i(){c.effectiveDate=new Date()}i();function e(){var n=new Date();n.setFullYear(n.getFullYear()+1);c.endDate=n}e();function f(p){var n=new Date(p);var o=n.setFullYear(n.getFullYear()+1);return o}function m(){switch(l.cooperateType){case"0":l.cooperateType="CPA";break;case"1":l.cooperateType="CPC";break;case"2":l.cooperateType="CPI";break;case"3":l.cooperateType="CPT";break}}}]).controller("editData",["$scope","$rootScope","$http","$timeout",function(l,j,h,d){var a=[];var n=location.href;n.lastIndexOf("?")>=0&&(l.uname=n.substring(location.href.lastIndexOf("?")+1));l.editable=true;l.autoComplete="off";if(l.uname!="apy"){console.log(l.uname);h.get("data/getProducts.php?name="+j.uname).success(function(o){l.arrSort(o,"effectiveDate");l.products=o;j.products=l.products})}else{h.get("data/getAllProducts.php").success(function(o){var o=c(o);l.arrSort(o,"effectiveDate");l.products=o;j.products=l.products;a=l.products})}function c(p){var r=[p[0]];for(var q=1;q<p.length;q++){for(var o=0;o<r.length;o++){if(p[q].company==r[o].company){p[q].effectiveDate<r[o].effectiveDate&&(r[o]=p[q]);break}}if(o==r.length){r.push(p[q])}}return r}f();l.changeDis=function(){l.editable=false;l.autocomplete="on"};l.refresh=function(){l.clearSearchHistroy();f()};function f(){if(l.uname!="apy"){console.log(l.uname);h.get("data/getProducts.php?name="+j.uname).success(function(o){j.arrSort(o,"effectiveDate");l.products=o;j.products=l.products})}else{h.get("data/getAllProducts.php").success(function(o){var o=c(o);l.arrSort(o,"effectiveDate");l.products=o;j.products=l.products})}}var e={};$("#table-data").on("click","[sort-by]",function(p){var o=$(this).attr("sort-by");e[o]=e[o]||0;e[o]++;var q=e[o]%2;l.products.sort(function(s,r){if(o=="installCount"||o=="price"){return q?s[o]-r[o]:r[o]-s[o]}else{return q?s[o].localeCompare(r[o]):r[o].localeCompare(s[o])}});l.$apply()});l.searchData=function(){if(l.productName||l.channelNum||l.company||l.cooperateType){b();console.log(l.productName);var o="productName="+l.productName+"&channelNum="+l.channelNum+"&company="+l.company+"&cooperateType="+l.cooperateType;h.get("data/newSelectData.php?"+o).success(function(p){console.log(p);l.products=p;l.total=l.getInstallTotal(l.products);if(!p.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}};function b(){if(!l.productName){l.productName=""}if(!l.channelNum){l.channelNum=""}if(!l.company){l.company=""}if(!l.cooperateType){l.cooperateType=""}}l.saveEditData=function(o){if(l.editable==false&&l.cooperateVerified&&l.priceVerified){var p=l.products[o].productName+"&channelNum="+l.products[o].channelNum+"&cooperateType="+l.products[o].cooperateType.toUpperCase()+"&company="+l.products[o].company+"&price="+l.products[o].price+"&did="+l.products[o].did;h.get("data/saveEdit_Table.php?productName="+p).success(function(s){var t=$("#table-data tbody tr").eq(o);if(s=="Update Succ!"){console.log("修改成功");var r=t.css("background");t.css("background","#81E3D6");d(function(){t.css("background",r)},5000)}else{var q=t.css("color");t.css("color","#f00");d(function(){t.css("color",q);l.abandon(o)},5000)}})}};l.verifiedCooperate=function(o){var p=["CPA","CPC","CPI","CPT"];if(p.indexOf(l.products[o].cooperateType.toUpperCase())<0){l.verifiedDataMsg="合作类型只能从:CPA,CPC,CPI,CPT中选择一种.";$("#verifiedData").show(500)}else{l.cooperateVerified=true}};l.verifiedPrice=function(o){if(!/\d/g.test(l.products[o].price)){l.verifiedDataMsg="输入的数据类型不对.";$("#verifiedData").show(500)}else{l.priceVerified=true}};l.closeVerifiedData=function(){$("#verifiedData").hide(500)};l.abandon=function(o){if(!l.editable){console.log(o);console.log(l.products[o].did);console.log(l.products,a);console.log(l.products.length,a.length);var q=l.products[o].did;var p=k(q,a);console.log(p);console.log(a[p].installCount);l.products[o].installCount=a[p].installCount;l.editable=true}};function k(p,q){for(var o=0;o<q.length;o++){console.log(q[o].did);if(q[o].did==p){return o}}}l.isShow="hidden";l.firstInsertIndex=[];l.newAddData=[];l.save=function(){var o={};console.log(l.cooperateType);m();if(l.productName&&l.channelNum&&l.company&&l.compAbbreviation&&l.cooperateType&&l.price&&l.effectiveDate&&l.endDate){if((l.effectiveDate.getTime()+1000*3600*24*365)<=l.endDate.getTime()&&/\d/g.test(parseInt(l.price))){h.get("data/insertData02.php?proName="+l.productName+"&channelName="+l.channelNum+"&company="+l.company+"&compabbr="+l.compAbbreviation+"&coopType="+l.cooperateType+"&price="+l.price+"&effeDate="+l.effectiveDate.getTime()+"&endDate="+l.endDate.getTime()).success(function(p){console.log(p);if(p.msg=="Insert Succ!"){l.isShow="visible";l.insertMsg="输入成功!!!";l.firstInsertIndex.push(p.did);h.get("data/returnNewAdd.php?did="+p.did).success(function(q){console.log(q);l.newAddData.push(q);l.arrSort(l.newAddData,"effectiveDate");l.products=l.newAddData;a.concat(l.newAddData);a.push(q);console.log(a,a.length)})}else{l.isShow="visible";l.insertMsg="输入有误!!!"}})}else{l.isShow="visible";l.insertMsg="输入有误或格式不对!!"}}else{l.isShow="visible";l.insertMsg="漏输入或输入有误或格式不对!!"}l.clearSearchHistroy()};l.close=function(){$("#editContent").hide(500);l.clearSearchHistroy()};function m(){switch(l.cooperateType){case"0":l.cooperateType="CPA";break;case"1":l.cooperateType="CPC";break;case"2":l.cooperateType="CPI";break;case"3":l.cooperateType="CPT";break}}function i(){l.effectiveDate=new Date()}i();function g(){var o=new Date();o.setFullYear(o.getFullYear()+1);l.endDate=o}g();l.clearSearchHistroy=function(){l.productName="";l.channelNum="";l.cooperateType="";l.company="";l.compAbbreviation="";l.price=""}}]).controller("resetPwd",["$scope","$http",function(a,b){a.pwdAlert=true;a.isUser="hidden";a.resetSucc="hidden";a.$watch("uname",function(){console.log(a.uname)});a.close=function(){$("#resetPwd").hide(500)};a.checkIsUser=function(){var c=/^[a-zA-Z0-9]+?/;console.log(c.test(a.uname));if(c.test(a.uname)){console.log(a.uname);b.get("data/checkIsUser.php?uname="+a.uname).success(function(d){console.log(d);if(d=="user is being"){a.isUser="hidden";a.isUserMsg=""}else{a.isUser="visible";a.isUserMsg="该用户不存在!!请重新输入"}})}else{a.isUser="visible";a.isUserMsg="用户名不能包含汉字"}};a.checkIpntPwd=function(){console.log(a.isUserMsg);if(a.firstPwd!=a.secondPwd){a.pwdAlert=false}else{if(a.firstPwd.length>=6&&a.isUserMsg==""){b.get("data/changePwd.php?uname="+a.uname+"&pwd="+a.secondPwd).success(function(c){console.log(c)});a.resetSucc="visible";a.resetSuccess="密码更改成功!!!";a.clearAllPwd()}}};a.changeResetmsg=function(){a.resetSuccess=""};a.clearAllPwd=function(){a.firstPwd="";a.secondPwd=""}}]);