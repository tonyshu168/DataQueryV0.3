angular.module("dataQuery",["ng"]).controller("mainCtrl",["$scope","$rootScope","$http","$interval","$timeout",function(l,h,g,f,c){l.change=function(){$("#changePwd").show(500)};l.resetPwd=function(){$("#resetPwd").show(500)};l.showExportExcel=function(){$("#exportExcel").show(500)};l.$watch("uname",function(){h.uname=l.uname});l.close=function(){$("#changePwd").hide(500)};l.closeAlert=function(){$("#selectAlert").fadeOut(500)};l.refresh=function(){!l.pager&&(l.pager=true);if(l.uname!="apy"){g.get("data/getProducts_pager.php?name="+h.uname+"&pno=1").success(function(m){l.arrSort(m.data["products"],"effectiveDate");l.products=l.changeAdId(m.data["products"],"adID");h.products=l.products;m.page_count>1&&l.createBtn(m,1);l.pagerClick()});g.get("data/getProducts_installCount.php?name="+h.uname).success(function(m){h.total=l.getInstallTotal(m)});$("#addEdit").css("display","none")}else{g.get("data/getAllProducts_pager.php?pno=1").success(function(o){l.arrSort(o.data["products"],"effectiveDate");o.data["products"]=l.changeEffeDate(o.data["products"]);l.products=l.changeAdId(o.data["products"],"adID");h.products=l.products;h.total=l.getInstallTotal(l.products);for(var n=0;n<l.products.length;n++){h.oldProducts[n]={};for(var m in l.products[n]){h.oldProducts[n][m]=l.products[n][m]}}o.page_count>1&&l.createBtn(o,1);l.pagerClick();g.get("data/getAllProducts_installCount.php").success(function(p){h.total=l.getInstallTotal(p)})})}l.clearSearchHistroy()};l.search=function(){l.pager=false;if(h.uname=="apy"){if(l.productName||l.channelNum||l.company||l.coopType||l.effectiveDate||l.endDate){a();var o="productName="+l.productName+"&channelNum="+l.channelNum+"&company="+l.company+"&cooperateType="+l.coopType+"&effectiveDate="+(l.effectiveDate?l.effectiveDate.getTime():"")+"&endDate="+(l.endDate?l.endDate.getTime():"");g.get("data/newSelectDataV2.php?"+o).success(function(p){l.arrSort(p,"effectiveDate");p=l.changeEffeDate(p);l.products=l.changeAdId(p,"adID");l.total=l.getInstallTotal(l.products);if(!p.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}}else{if(l.productName||l.channelNum||l.company||l.cooperateType||l.effectiveDate||l.endDate){if(l.effectiveDate){var n=l.effectiveDate.getTime()}else{var n=""}if(l.endDate){var m=l.endDate.getTime()}else{var m=""}a();var o=l.productName+"&channelNum="+l.channelNum+"&company="+l.company+"&cooperateType="+l.coopType+"&uname="+l.uname+"&effectiveDate="+n+"&endDate="+m;g.get("data/newSelectData_self.php?productName="+o).success(function(p){l.arrSort(p,"effectiveDate");l.products=l.changeAdId(p,"adID");h.total=l.getInstallTotal(l.products);if(!p.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}}};function a(){if(!l.productName){l.productName=""}if(!l.channelNum){l.channelNum=""}if(!l.company){l.company=""}if(!l.coopType){l.coopType=""}}l.addRows=function(){if(h.uname=="apy"){$("#editContent").show(500)}};l.jumpPage=function(m){window.open("editBack02.html?"+m)};l.index=0;l.openEditWindow=function(){l.index=this.$index;$("#editContent").show(500)};l.inputProductInfo=function(){$("#inputProductInfo").show(500)};l.delRow=function(){console.log(this.$index);if(confirm){l.products.splice(this.$index,1)}};l.reverseArr=function(){l.products.reverse()};function j(m){$.each(m,function(n){m[n].effectiveDate=new Date(m[n].effectiveDate)})}l.changeDate=function(n){var m=new Date(n*1);if(/^\d+$/g.test(n)){m=m.toLocaleDateString().replace(/\/|[\u4e00-\u9fa5]/g,"-");return m.replace(/-$/g,"")}else{m=n.replace(/\/|[\u4e00-\u9fa5]/g,"-");m=m.replace(/-$/g,"");var p=m.replace(/\d/g,"*");var o=p.lastIndexOf("****");o>1&&(m=m.substr(o,4)+m.substring(0,o-1));p=null;o=null;return m}};l.arrSort=function(q,p){for(var o=1;o<q.length;o++){for(var n=0,m={};n<q.length-o;n++){if(q[n][p]*1<q[n+1][p]*1){m=q[n];q[n]=q[n+1];q[n+1]=m}}}};l.changeEffeDate=function(o){for(var n=0;n<o.length;n++){var m=new Date(o[n].effectiveDate*1);o[n].effectiveDate=m.toLocaleDateString().replace(/\/|[\u4e00-\u9fa5]/g,"-").replace(/-$/,"")}return o};var e={};$("#table-data").on("click","[sort-by]",function(n){var m=$(this).attr("sort-by");e[m]=e[m]||0;e[m]++;var o=e[m]%2;l.products.sort(function(q,p){if(m=="installCount"||m=="price"){return o?q[m]-p[m]:p[m]-q[m]}else{return o?q[m].localeCompare(p[m]):p[m].localeCompare(q[m])}});l.$apply()});$("#searchAppend").on("input",function(){l.products.forEach(function(n,m){n.isHide=false});$(this).find("[filter]").each(function(){var m=$(this).attr("filter");var n=this.value;l.products.forEach(function(p,o){p.isHide=p.isHide||(n&&(p.isHide=(p[m]||"").toLowerCase()!=(n||"").toLowerCase()))})});l.$apply()});f(function(){!l.pager&&(l.pager=true);if(l.uname!="apy"){g.get("data/getProducts_pager.php?name="+h.uname+"&pno=1").success(function(m){l.arrSort(m.data["products"],"effectiveDate");l.products=l.changeAdId(m.data["products"],"adID");h.products=l.products;m.page_count>1&&l.createBtn(m,1);l.pagerClick()});g.get("data/getProducts_installCount.php?name="+h.uname).success(function(m){h.total=l.getInstallTotal(m)});$("#addEdit").css("display","none")}else{g.get("data/getAllProducts_pager.php?pno=1").success(function(o){l.arrSort(o.data["products"],"effectiveDate");o.data["products"]=l.changeEffeDate(o.data["products"]);l.products=l.changeAdId(o.data["products"],"adID");h.products=l.products;h.total=l.getInstallTotal(l.products);h.oldProducts=null;for(var n=0;n<l.products.length;n++){h.oldProducts[n]={};for(var m in l.products[n]){h.oldProducts[n][m]=l.products[n][m]}}o.page_count>1&&l.createBtn(o,1);l.pagerClick();g.get("data/getAllProducts_installCount.php").success(function(p){h.total=l.getInstallTotal(p)})})}l.$apply()},1000*3600*2);l.editable=true;l.autoComplete="off";h.oldProducts=[];l.changeDis=function(){l.oldInstallCount=parseInt(this.data.installCount);l.editable=false;l.autocomplete="on"};l.checkDate=function(o){var p=/^\d{4,}(-|\/)1[0-2]|[1-9]{1,2}(-|\/)\d{1,2}$/;var m=/^([0-2][0-9](?!(00)))|3[0-1]|[1-9]$/;var q=/^\d{4,}年(1[0-2]|[0-9]{1,2})月(([0-2][0-9](?!(00)))|3[0-1]|[1-9])日$/;if(p.test(o)&&m.test(o.substr(o.length-2))||q.test(o)){if(q.test(o)){o=(o.replace(/(年|月)/g,"-").substr(0,10))}var n=new Date(o).getTime();if(n<=new Date().getTime()+1000*3600*24*365){return n}else{return 0}}else{return 0}};l.saveEditData=function(m){if(l.editable==false){var n=/\d/g;var p=n.test(l.products[m].adID)||l.products[m].adID=="";var o=l.products[m].installCount;if(o&&l.checkDate(l.products[m].effectiveDate)&&p){l.products[m].effectiveDate=l.checkDate(l.products[m].effectiveDate);l.products[m].effectiveDate=new Date(l.products[m].effectiveDate).toLocaleString().replace(/\//g,"-").substr(0,10);g.get("data/saveInstallCountV2.php?installCount="+l.products[m].installCount+"&productName="+l.products[m].productName+"&channelNum="+l.products[m].channelNum+"&company="+l.products[m].company+"&price="+l.products[m].price+"&effectiveDate="+new Date(l.products[m].effectiveDate).getTime()+"&did="+l.products[m].did+"&adPlatform="+l.products[m].adPlatform+"&adID="+l.products[m].adID).success(function(s){var t=$("#table-data tbody tr").eq(m);if(s=="Update Succ!"){console.log("修改成功");var r=t.css("background");t.css("background","#81E3D6");c(function(){t.css("background",r)},5000);l.total+=parseInt(l.products[m].installCount)-l.oldInstallCount}else{var q=t.css("color");t.css("color","#f00");c(function(){t.css("color",q);l.abandon(m)},5000)}})}else{console.log("输入的必须为数字或输入的日期格式不对!!")}o=null}};l.abandon=function(m){if(!l.editable){var o=l.products[m].did;var n=i(o,l.oldProducts);l.products[m].installCount=h.oldProducts[n].installCount}};function i(n,o){for(var m=0;m<o.length;m++){if(o[m].did==n){return m}}}l.clearSearchHistroy=function(){l.productName="";l.channelNum="";l.cooperateType="";l.company="";l.effectiveDate="";l.endDate=""};l.encipher=function(o){var n=o.split("");for(var m=0;m<n.length;m++){n[m]=n[m].charCodeAt()+6*(m+1)}return n.join(",")};l.decipher=function(o){var n=o.split(",");for(var m=0;m<n.length;m++){n[m]=String.fromCharCode(n[m]-6*(m+1))}return n.join("")};l.getInstallTotal=function(o){var n=null;for(var m=0;m<o.length;m++){n+=parseInt(o[m].installCount)}return n};l.pager=true;var k=0;const d=18;l.createBtn=function(n,m){$(".pager_custom").empty();k=n.page_count;$(".pager_custom").append('<li><a href = "#">上一页</a></li>');for(var o=1;o<=n.page_count;o++){if(o==m){$(".pager_custom").append('<li class = "active"><a href = "#">'+n.cur_page+"</a></li>")}else{$(".pager_custom").append('<li><a href = "#">'+o+"</a></li>")}if(o>=d&&o<n.page_count){$(".pager_custom").append("<span>...</span>");break}}$(".pager_custom").append('<li><a href = "#">下一页</a></li>')};function b(n,m){if(n!="apy"){g.get("data/getProducts_pager.php?name="+n+"&pno="+m).success(function(o){l.arrSort(o.data["products"],"effectiveDate");l.products=null;h.products=null;l.products=l.changeAdId(o.data["products"],"adID");h.products=l.products})}else{g.get("data/getAllProducts_pager.php?pno="+m).success(function(o){l.arrSort(o.data["products"],"effectiveDate");o.data["products"]=l.changeEffeDate(o.data["products"]);l.products=null;h.products=null;l.products=l.changeAdId(o.data["products"],"adID");h.products=l.products})}}l.pagerClick=function(){const o=2;$("ul.pager_custom >li > a").on("click",function(u){u.preventDefault();var t=u.target||u.srcElement;var s=$(t).parent().siblings(".active").children(0).html();if($("#self_company").css("display")!="none"){var r=$("#mainContent > ul.pager_custom > li").length;var p=$("#mainContent > ul.pager_custom > li").index(this.parentNode)}else{var r=$("#other_user > ul.pager_custom > li").length;var p=$("#other_user > ul.pager_custom > li").index(this.parentNode)}var q=parseInt(t.innerHTML);if(/\d/.test(t.innerHTML)){if(t.parentElement.className=="active"){return}n(p,d+2)}else{if(t.innerHTML=="上一页"&&s!="1"){if(!(s==3&&$(t).parent().siblings(".active").prev()[0].tagName=="SPAN")){m(1,r);$(t).parent().siblings(".active").removeClass("active").prev().addClass("active")}}else{if(t.innerHTML=="下一页"&&s<=k){s<k&&$(t).parent().siblings(".active").removeClass("active").next().addClass("active");m(-1,r)}}}if(t.innerHTML=="上一页"&&(parseInt(s)>1)){b(l.uname,parseInt(s)-1)}else{if(t.innerHTML=="下一页"&&(parseInt(s)<k)){b(l.uname,parseInt(s)+1)}else{if(parseInt(t.innerHTML)!=parseInt(s)){!isNaN(parseInt(t.innerHTML))&&b(l.uname,q)}}}});function m(r,s){var u=$("ul.pager_custom > li").siblings(".active").children(0).html()||1;var v=$("ul.pager_custom > li:last").prev().html()=="..."?$("ul.pager_custom > span:last").prev().children(0).html():$("ul.pager_custom > li:last").prev().children(0).html();var q=$("ul.pager_custom > li").siblings(".active").index();var w=q+(v-u);var p=$("ul.pager_custom > li > a");if(p[3].innerHTML==4&&$(p[3]).parent().hasClass("active")){console.log(p[3].innerHTML==4&&$(p[3]).parent().hasClass("active"));$(p[1]).parent().next()[0].tagName=="SPAN"&&$(p[1]).parent().next().remove();$(p[s-1]).parent().before("<span>...</span>");for(var t=s-2;t>=2;t--){p[t].innerHTML-=1}}if(p[s-3].innerHTML==k-2&&$(p[s-3]).parent().hasClass("active")){$(p[s-1]).parent().prev().remove();$(p[1]).parent().next()[0].tagName!=="SPAN"&&$(p[1]).parent().after("<span>...</span>");for(var t=s-2;t>=2;t--){p[t].innerHTML=parseInt(p[t].innerHTML)+1}}}function n(s,r){if($("#self_company").css("display")!="none"){var u=parseInt($("#mainContent >ul.pager_custom > li").eq(s).find("a").html());var p=$("#mainContent >ul.pager_custom > li > a")}else{var u=parseInt($("#other_user >ul.pager_custom > li").eq(s).find("a").html());var p=$("#other_user >ul.pager_custom > li > a")}if(u<k&&u+o>r-2&&k>d){$(p[1]).parent().next()[0].tagName!="SPAN"&&$(p[1]).parent().after("<span>...</span>");console.log(k);if(u==k-1){if(p[r-2].parentElement.nextElementSibling.tagName=="SPAN"){$(p[r-2]).parent().next().remove();$(p[r-1]).parent().prev()[0].tagName!="SPAN"&&$(p[r-1]).parent().before("<span>...</span>")}console.log(p[r-2].innerHTML);if(p[r-2].innerHTML<k){for(var t=r-2;t>=2;t--){p[t].innerHTML=parseInt(p[t].innerHTML)+1}!$(p[r-2]).parent().has(".active")&&$(p[r-2]).parent().addClass("active").siblings(".active").removeClass("active")}}for(var t=r-2,q=0;t>=2;t--,q++){if(u+o<=k){p[t].innerHTML=u+o-q;if(p[t].innerHTML==u){$(p[t]).parent().addClass("active").siblings(".active").removeClass("active")}}else{if(u>=k-1){$(p[u-2]).parent().addClass("active").siblings(".active").removeClass("active")}}$(p[r-1]).parent().prev()[0].tagName=="SPAN"&&$(p[r-1]).parent().prev().remove()}}else{if(u==k){if($("#self_company").css("display")!="none"){$("#mainContent > ul.pager_custom > li").eq(s).addClass("active").siblings(".active").removeClass("active")}else{$("#other_user > ul.pager_custom > li").eq(s).addClass("active").siblings(".active").removeClass("active")}}else{if($("#self_company").css("display")!="none"){$("#mainContent > ul.pager_custom > li").eq(s).addClass("active").siblings(".active").removeClass("active")}else{$("#other_user > ul.pager_custom > li").eq(s).addClass("active").siblings(".active").removeClass("active")}var r=$("#self_company").css("display")!="none"?$("#mainContent > ul.pager_custom > li").length:$("#other_user > ul.pager_custom > li").length;if(k>r-2){for(var t=2;t<r-1;t++){p[t].innerHTML=t;$(p[1]).parent().next()[0].tagName=="SPAN"?$(p[1]).parent().next().remove():""}$(p[r-1]).parent().prev()[0].tagName!="SPAN"&&$(p[r-1]).parent().before("<span>...</span>")}}}}};l.saveInputProductInfo=function(m){var n=localStorage.products?JSON.parse(localStorage.products):"";!n&&(n={});if(!n.productName||n.productName.length<9){if(!n.productName){n.productName=[];n.productName.push(m.productName)}n.productName&&$.inArray(m.productName,n.productName)<0&&n.productName.push(m.productName)}if(!n.channelNum||n.channelNum.length<8){if(!n.channelNum){n.channelNum=[];n.channelNum.push(m.channelNum)}n.channelNum&&$.inArray(m.channelNum,n.channelNum)<0&&n.channelNum.push(m.channelNum)}if(!n.company||n.company.length<8){if(!n.company){n.company=[];n.company.push(m.company)}n.company&&$.inArray(m.company,n.company)<0&&n.company.push(m.company)}if(!n.compAbbreviation||n.compAbbreviation.length<8){if(!n.compAbbreviation){n.compAbbreviation=[];n.compAbbreviation.push(m.compAbbreviation)}n.compAbbreviation&&$.inArray(m.compAbbreviation,n.compAbbreviation)<0&&n.compAbbreviation.push(m.compAbbreviation)}if(!n.adPlatform||n.adPlatform.length<8){if(!n.adPlatform){n.adPlatform=[];n.adPlatform.push(m.adPlatform)}n.adPlatform&&$.inArray(m.adPlatform,n.adPlatform)<0&&n.adPlatform.push(m.adPlatform)}if(!n.adID||n.adID.length<8){if(!n.adID){n.adID=[];n.adID.push(m.adID)}n.adID&&$.inArray(m.adID,n.adID)<0&&n.adID.push(m.adID)}localStorage.products=JSON.stringify(n)};l.selectValue=function(n,m){switch(n){case"productName":h.productName=l.productName=m;break;case"channelNum":h.channelNum=l.channelNum=m;break;case"company":h.company=l.company=m;break;case"compAbbreviation":h.compAbbreviation=l.compAbbreviation=m;break;case"adPlatform":h.adPlatform=l.adPlatform=m;break;case"adID":h.adID=l.adID=m}};l.keyEvent=function(){var m=$("div.input input.regInput");m.on("blur",function(){var n=this;var o=c(function(){n.nextElementSibling&&(n.nextElementSibling.style.zIndex=-1)},300)}).on("keydown",function(t){if(t.keyCode=="9"){return}var p=$(this).next();p.css("z-index")==-1&&p.css("z-index",1);if(localStorage.products){var q="";var o=this.getAttribute("ng-model");var u=this;l.$watch(o,function(){var x=JSON.parse(localStorage.products);var y=x[o];for(var w in y){q+="<li>"+y[w]+"</li>"}$(u).next().html(q).show();$(u).next().children().on("click",function(A){u.value=this.innerHTML;var z=u.getAttribute("ng-model");l.selectValue(z,this.innerHTML);$(this).parent().hide();l.$apply();$("ul.autoAppend").html("")})})}var v=$(this).next().find("li");var s=$(this).next().children(".hover").index();switch(t.keyCode){case 37:break;case 38:s==-1?s=0:s==0?s=v.length-1:s--;v.eq(s).addClass("hover").siblings(".hover").removeClass("hover");v.eq(s).html()&&(this.value=v.eq(s).html());break;case 39:break;case 40:s==-1||s==v.length-1?s=0:s++;console.log(s);v.eq(s).addClass("hover").siblings(".hover").removeClass("hover");v.eq(s).html()&&(this.value=v.eq(s).html());break;case 13:t.preventDefault()||t.preventBubble;var r=$(this).next().find("li.hover");var n=this.getAttribute("ng-model");l.selectValue(n,r.html());l.$apply();$("ul.autoAppend").html("")}})};l.changeAdId=function(n,m){if(!n||arguments.length==1){return}$.each(n,function(){this[m]==0&&(this[m]="")});return n}}]).controller("login",["$scope","$http","$rootScope",function(c,e,a){c.show=true;if(localStorage.uname){d()}c.verification=function(){e.get("data/verificationUserPwd.php?uname="+c.uname+"&pwd="+c.encipher(c.pwd)).success(function(f){if(f!="login succ!"){c.show=false}else{if(c.select==true){b(c.uname,c.pwd)}$("#login-container").hide(500);a.uname=c.uname;if(c.uname!="apy"){$("#self_company").hide();$("#other_user").show();e.get("data/getProducts_pager.php?name="+a.uname+"&pno=1").success(function(g){c.arrSort(g.data["products"],"effectiveDate");c.products=c.changeAdId(g.data["products"],"adID");a.products=c.products;g.page_count>1&&c.createBtn(g,1);c.pagerClick()});e.get("data/getProducts_installCount.php?name="+a.uname).success(function(g){a.total=c.getInstallTotal(g)});$("#addEdit").css("display","none")}else{e.get("data/getAllProducts_pager.php?pno=1").success(function(j){c.arrSort(j.data["products"],"effectiveDate");j.data["products"]=c.changeEffeDate(j.data["products"]);c.products=c.changeAdId(j.data["products"],"adID");a.products=c.products;a.total=c.getInstallTotal(c.products);for(var h=0;h<c.products.length;h++){a.oldProducts[h]={};for(var g in c.products[h]){a.oldProducts[h][g]=c.products[h][g]}}j.page_count>1&&c.createBtn(j,1);c.pagerClick();e.get("data/getAllProducts_installCount.php").success(function(i){a.total=c.getInstallTotal(i)})})}}})};function b(f,g){window.localStorage.uname=f;window.localStorage.pwd=c.encipher(g);window.localStorage.loginTime=new Date().getTime()}function d(){var g=localStorage.uname;var i=c.decipher(localStorage.pwd);var f=localStorage.loginTime;var h=new Date().getTime();if((h-f)>1000*3600*24*7){localStorage.removeItem("uname");localStorage.removeItem("pwd")}else{c.uname=g;c.pwd=i}}}]).controller("changePwd",["$scope","$rootScope","$http",function(c,a,d){c.pwdAlert=true;c.oldPwdAlert="hidden";var b=true;c.$watch("uname",function(){});c.verificationOldPwd=function(){if(c.pwd){d.get("data/verificationUserPwd.php?uname="+c.uname+"&pwd="+c.encipher(c.pwd)).success(function(e){if(e!="login succ!"){c.oldPwdAlert="visible";b=false}else{c.oldPwdAlert="hidden"}})}};c.checkIpntPwd=function(){if(c.firstPwd!=c.secondPwd){c.pwdAlert=false}else{if(c.firstPwd.length>=6&&b){d.get("data/changePwd.php?uname="+c.uname+"&pwd="+c.encipher(c.secondPwd)).success(function(e){});$("#changePwd").hide(500);c.clearAllPwd()}}};c.clearAllPwd=function(){c.pwd="";c.firstPwd="";c.secondPwd=""}}]).controller("editContent",["$scope","$rootScope","$http",function(c,a,e){c.isShow="hidden";c.firstInsertIndex=[];c.newAddData=[];c.save=function(){var f={};console.log(c.cooperateType);d();if(c.productName&&c.channelNum&&c.company&&c.compAbbreviation&&c.cooperateType&&c.price&&c.effectiveDate&&c.endDate){if((c.effectiveDate.getTime()+1000*3600*24*365)<=c.endDate.getTime()&&/\d/g.test(parseInt(c.price))){e.get("data/insertData02.php?proName="+c.productName+"&channelName="+c.channelNum+"&company="+c.company+"&compabbr="+c.compAbbreviation+"&coopType="+c.cooperateType+"&price="+c.price+"&effeDate="+c.effectiveDate.getTime()+"&endDate="+c.endDate.getTime()).success(function(g){console.log(g);if(g.msg=="Insert Succ!"){c.isShow="visible";c.insertMsg="输入成功!!!";c.firstInsertIndex.push(g.did);e.get("data/returnNewAdd.php?did="+g.did).success(function(h){console.log(h);c.newAddData.push(h);c.products=c.newAddData})}else{c.isShow="visible";c.insertMsg="输入有误!!!"}})}else{c.isShow="visible";c.insertMsg="输入有误或格式不对!!"}}};c.close=function(){$("#editContent").hide(500)};function d(){switch(c.cooperateType){case"0":c.cooperateType="CPA";break;case"1":c.cooperateType="CPC";break;case"2":c.cooperateType="CPI";break;case"3":c.cooperateType="CPT";break}}function b(){var f=new Date();f.setFullYear(f.getFullYear()+1);c.endDate=f}b()}]).controller("editBack",["$scope","$rootScope","$http","$timeout",function(m,k,h,b){var i={};i.productName=[];i.channelNum=[];i.company=[];i.compAbbreviation=[];var d=m;d.isVisi="hidden";d.dateShow="hidden";d.close=function(){$("#inputProductInfo").hide(500);l();m.clearSearchHistroy()};d.verifiedDate=function(){var o=new Date(d.effectiveDate);if(d.effectiveDate){d.endDate=d.effectiveDate;d.endDate.setFullYear(d.effectiveDate.getFullYear()+1)}d.isVisi="hidden"};d.checkDate=function(){var o=new Date(d.effectiveDate);var p=new Date(d.endDate);d.effectiveDate&&(d.effectiveDate=o.getTime());d.endDate&&(d.endDate=p.getTime());d.isVisi="hidden";if(p.getTime()<(o.getTime()+1000*3600*24*365)){console.log(p.getTime());d.dateShow="visible";d.dateMsg="结束日期必须大于生效日期+1年"}else{d.dateShow="hidden";d.dateMsg=""}d.effectiveDate=o.toLocaleDateString().replace(/\//g,"-");d.endDate=p.toLocaleDateString().replace(/\//g,"-")};var c=false;d.veriPrice="hidden";d.verifiedPrice=function(){if(d.price){c=/^^(\d)*(.)?(\d)*$/.test(d.price);if(!c){d.veriPrice="visible";d.priceAlert="单价必须为数字!!"}else{d.veriPrice="hidden";d.priceAlert=""}}};var e=false;d.verifiedInstall=function(){if(d.installCount){installMsg=/^(\d)*$/.test(d.installCount);if(!installMsg){d.isVisi="visible";d.isSucc="安装量必须为数字或整数"}else{d.isVisi="hidden";d.isSucc=""}}};m.firstInsertIndex=[];m.newAddData=[];var a=[];d.save=function(){var o={};n();if(m.productName&&m.channelNum&&m.company&&m.compAbbreviation&&m.cooperateType&&c&&installMsg&&d.effectiveDate&&d.adPlatform&&d.adID){var p="adPlatform="+d.adPlatform+"&adID="+d.adID+"&proName="+encodeURIComponent(k.productName)+"&channelName="+d.channelNum+"&company="+encodeURIComponent(k.company)+"&compabbr="+d.compAbbreviation+"&coopType="+d.cooperateType+"&price="+d.price+"&installCount="+d.installCount+"&effeDate="+d.effectiveDate.getTime()+"&endDate="+d.endDate.getTime();h.get("data/insertDataAll.php?"+p).success(function(r){if(r.msg=="Insert Succ!"){d.isVisi="visible";m.isSucc="输入成功!!!";m.firstInsertIndex.push(r.did);h.get("data/returnNewAdd.php?did="+r.did).success(function(s){m.newAddData.push(s);m.arrSort(m.newAddData,"effectiveDate");m.products=m.newAddData;a.concat(m.newAddData);a.push(s)});var q={productName:d.productName,channelNum:d.channelNum,company:d.company,compAbbreviation:d.compAbbreviation};m.saveInputProductInfo(q)}else{m.isVisi="visible";m.isSucc="输入有误!!!"}})}else{console.log(m.productName,m.channelNum,m.company,m.compAbbreviation,m.cooperateType,c,installMsg,d.effectiveDate,d.adPlatform,d.adID);m.isVisi="visible";m.isSucc="漏输入或输入有误或格式不对!!"}m.clearSearchHistroy()};function l(){m.productName="";m.channelNum="";m.company="";m.compAbbreviation="";m.price="";m.installCount=""}document.querySelector("#inputProductInfo").addEventListener("click",function(o){$("#eidtBack-form input.regInput").next().hide().html("");$("#eidtBack-form  input.regInput").each(function(p,q){if(q.value){m.selectValue(q.getAttribute("ng-model"),q.value)}})});d.keyEvent();function j(){d.effectiveDate=new Date()}j();function f(){var o=new Date();o.setFullYear(o.getFullYear()+1);d.endDate=o}f();function g(q){var o=new Date(q);var p=o.setFullYear(o.getFullYear()+1);return p}function n(){switch(m.cooperateType){case"0":m.cooperateType="CPA";break;case"1":m.cooperateType="CPC";break;case"2":m.cooperateType="CPI";break;case"3":m.cooperateType="CPT";break}}}]).controller("editData",["$scope","$rootScope","$http","$timeout",function(l,j,h,d){var a=[];var n=location.href;n.lastIndexOf("?")>=0&&(l.uname=n.substring(location.href.lastIndexOf("?")+1));l.editable=true;l.autoComplete="off";if(l.uname!="apy"){console.log(l.uname);h.get("data/getProducts.php?name="+j.uname).success(function(o){l.arrSort(o,"effectiveDate");l.products=l.changeAdId(o,"adID");j.products=l.products})}else{h.get("data/getAllProducts.php").success(function(o){var o=c(o);l.arrSort(o,"effectiveDate");l.products=l.changeAdId(o,"adID");j.products=l.products;a=l.products})}function c(p){var r=[p[0]];for(var q=1;q<p.length;q++){for(var o=0;o<r.length;o++){if(p[q].company==r[o].company){parseInt(p[q].effectiveDate)>parseInt(r[o].effectiveDate)&&(r[o]=p[q]);break}}if(o==r.length){r.push(p[q])}}return r}f();l.changeDis=function(){l.editable=false;l.autocomplete="on"};l.refresh=function(){l.clearSearchHistroy();f()};function f(){if(l.uname!="apy"){console.log(l.uname);h.get("data/getProducts.php?name="+j.uname).success(function(o){j.arrSort(o,"effectiveDate");l.products=l.changeAdId(o,"adID");j.products=l.products})}else{h.get("data/getAllProducts.php").success(function(o){var o=c(o);l.arrSort(o,"effectiveDate");l.products=l.changeAdId(o,"adID");j.products=l.products})}}var e={};$("#table-data").on("click","[sort-by]",function(p){var o=$(this).attr("sort-by");e[o]=e[o]||0;e[o]++;var q=e[o]%2;l.products.sort(function(s,r){if(o=="installCount"||o=="price"){return q?s[o]-r[o]:r[o]-s[o]}else{return q?s[o].localeCompare(r[o]):r[o].localeCompare(s[o])}});l.$apply()});l.searchData=function(){if(l.productName||l.channelNum||l.company||l.cooperateType){b();console.log(l.productName);var o="productName="+l.productName+"&channelNum="+l.channelNum+"&company="+l.company+"&cooperateType="+l.cooperateType;h.get("data/newSelectData.php?"+o).success(function(p){console.log(p);l.products=p;l.total=l.getInstallTotal(l.products);if(!p.length){console.log("没查找到符合你要求的数据!!");$("#selectAlert").fadeIn(500)}})}};function b(){if(!l.productName){l.productName=""}if(!l.channelNum){l.channelNum=""}if(!l.company){l.company=""}if(!l.cooperateType){l.cooperateType=""}}l.saveEditData=function(o){var q=/\d/g;var p=q.test(l.products[o].adID)||l.products[o].adID=="";if(l.editable==false&&p&&l.cooperateVerified&&l.priceVerified){var r=l.products[o].productName+"&adID="+l.products[o].adID+"&channelNum="+l.products[o].channelNum+"&cooperateType="+l.products[o].cooperateType.toUpperCase()+"&company="+l.products[o].company+"&price="+l.products[o].price+"&did="+l.products[o].did;h.get("data/saveEdit_Table.php?productName="+r).success(function(u){var v=$("#table-data tbody tr").eq(o);if(u=="Update Succ!"){console.log("修改成功");var t=v.css("background");v.css("background","#81E3D6");d(function(){v.css("background",t)},5000)}else{var s=v.css("color");v.css("color","#f00");d(function(){v.css("color",s);l.abandon(o)},5000)}})}};l.verifiedCooperate=function(o){var p=["CPA","CPC","CPI","CPT"];if(p.indexOf(l.products[o].cooperateType.toUpperCase())<0){l.verifiedDataMsg="合作类型只能从:CPA,CPC,CPI,CPT中选择一种.";$("#verifiedData").show(500)}else{l.cooperateVerified=true}};l.verifiedPrice=function(o){if(!/\d/g.test(l.products[o].price)){l.verifiedDataMsg="输入的数据类型不对.";$("#verifiedData").show(500)}else{l.priceVerified=true}};l.closeVerifiedData=function(){$("#verifiedData").hide(500)};l.abandon=function(o){if(!l.editable){console.log(o);console.log(l.products[o].did);console.log(l.products,a);console.log(l.products.length,a.length);var q=l.products[o].did;var p=k(q,a);console.log(p);console.log(a[p].installCount);l.products[o].installCount=a[p].installCount;l.editable=true}};function k(p,q){for(var o=0;o<q.length;o++){console.log(q[o].did);if(q[o].did==p){return o}}}document.querySelector("#editContent").addEventListener("click",function(){$("input.regInput").next().hide();$("#input-form  input.regInput").each(function(o,p){if(p.value){l.selectValue(p.getAttribute("ng-model"),p.value)}})});l.isShow="hidden";l.firstInsertIndex=[];l.newAddData=[];l.save=function(){var o={};console.log(l.cooperateType);m();l.productName=j.productName;l.channelNum=j.channelNum;l.company=j.company;l.compAbbreviation=j.compAbbreviation;if(l.channelNum&&l.company&&l.compAbbreviation&&l.cooperateType&&l.price&&l.effectiveDate&&l.endDate){l.productName=l.productName?l.productName:"";if((l.effectiveDate.getTime()+1000*3600*24*365)<=l.endDate.getTime()&&/\d/g.test(parseInt(l.price))){h.get("data/insertData02.php?proName="+l.productName+"&channelName="+l.channelNum+"&company="+l.company+"&compabbr="+l.compAbbreviation+"&coopType="+l.cooperateType+"&price="+l.price+"&effeDate="+l.effectiveDate.getTime()+"&endDate="+l.endDate.getTime()).success(function(p){console.log(p);if(p.msg=="Insert Succ!"){l.isShow="visible";l.insertMsg="输入成功!!!";l.firstInsertIndex.push(p.did);h.get("data/returnNewAdd.php?did="+p.did).success(function(q){console.log(q);l.newAddData.push(q);l.arrSort(l.newAddData,"effectiveDate");l.products=l.newAddData;a.concat(l.newAddData);a.push(q);console.log(a,a.length)})}else{l.isShow="visible";l.insertMsg="输入有误!!!"}})}else{l.isShow="visible";l.insertMsg="输入有误或格式不对!!"}}else{l.isShow="visible";l.insertMsg="漏输入或输入有误或格式不对!!"}l.clearSearchHistroy()};l.close=function(){$("#editContent").hide(500);l.clearSearchHistroy()};function m(){switch(l.cooperateType){case"0":l.cooperateType="CPA";break;case"1":l.cooperateType="CPC";break;case"2":l.cooperateType="CPI";break;case"3":l.cooperateType="CPT";break}}function i(){l.effectiveDate=new Date()}i();function g(){var o=new Date();o.setFullYear(o.getFullYear()+1);l.endDate=o}g();l.clearSearchHistroy=function(){l.productName="";l.channelNum="";l.cooperateType="";l.company="";l.compAbbreviation="";l.price=""};l.keyEvent()}]).controller("resetPwd",["$scope","$http",function(a,b){a.pwdAlert=true;a.isUser="hidden";a.resetSucc="hidden";a.$watch("uname",function(){});a.close=function(){$("#resetPwd").hide(500)};a.checkIsUser=function(){var c=/^[a-zA-Z0-9]+?/;console.log(c.test(a.uname));if(c.test(a.uname)){console.log(a.uname);b.get("data/checkIsUser.php?uname="+a.uname).success(function(d){console.log(d);if(d=="user is being"){a.isUser="hidden";a.isUserMsg=""}else{a.isUser="visible";a.isUserMsg="该用户不存在!!请重新输入"}})}else{a.isUser="visible";a.isUserMsg="用户名不能包含汉字"}};a.checkIpntPwd=function(){console.log(a.isUserMsg);if(a.firstPwd!=a.secondPwd){a.pwdAlert=false}else{if(a.firstPwd.length>=6&&a.isUserMsg==""){b.get("data/changePwd.php?uname="+a.uname+"&pwd="+a.encipher(a.secondPwd)).success(function(c){});a.resetSucc="visible";a.resetSuccess="密码更改成功!!!";a.clearAllPwd()}}};a.changeResetmsg=function(){a.resetSuccess=""};a.clearAllPwd=function(){a.firstPwd="";a.secondPwd=""}}]).controller("exportExcel",["$scope","$http","$rootScope",function(c,h,b){c.dateAlert=c.pageAlert="hidden";var a=$(".selectDate"),f=$(".selectPage"),g=$("#exportExcel .currentPage > input[type='checkbox']"),e=0,d=0;c.close=function(){$("#exportExcel").hide(500);clear()};c.selectCurrentPage=function(){g.attr("disabled")&&g.removeProp("disabled");if(g[0].checked){a.addClass("cancel").find("input").prop("disabled",true);f.addClass("cancel").find("input").prop("disabled",true)}else{a.removeClass("cancel").find("input").removeProp("disabled");f.removeClass("cancel").find("input").removeProp("disabled")}};c.selectDate=function(){e<1&&disabled("selectDate");e++;c.dateAlert=="visible"&&(c.dateAlert="hidden")};c.selectPage=function(){d<1&&disabled("selectPage");d++;c.pageAlert=="visible"&&(c.pageAlert="hidden")};c.submit=function(){a=$("div.selectDate"),f=$("div.selectPage"),g=$("#exportExcel .currentPage > input[type='checkbox']");if(!g.attr("disabled")){var i=$("ul.pager_custom > li.active").find("a").html();h.get("data/phpExcel/project/export.php?currentPage="+i).success(function(j){j=j?j:"http://ad.appholly.com/data/phpExcel/project/export.xls";console.log(j);open(location.href=j)});c.close();return}if(!a.hasClass("cancel")){h.get("data/phpExcel/project/export.php?effectiveDate="+c.effectiveDate+"&endDate="+c.endDate).success(function(j){j=j?j:"http://ad.appholly.com/data/phpExcel/project/export.xls";open(location.href=j)});c.close();return}if(!f.hasClass("cancel")){h.get("data/phpExcel/project/export.php?startPage="+c.startPage+"&finishPage="+c.finishPage).success(function(j){j=j?j:"http://ad.appholly.com/data/phpExcel/project/export.xls";c.close();open(location.href=j)})}};c.compareDate=function(){if(!c.effectiveDate||!c.endDate){return}c.effectiveDate=c.effectiveDate.getTime(),c.endDate=c.endDate.getTime();if(Math.abs(c.endDate-c.effectiveDate)/(1000*3600*24*365)>1){c.dateAlert="visible"}};c.comparePage=function(){if(!c.startPage||!c.finishPage){return}if(Math.abs(c.finishPage-c.startPage)>18){c.pageAlert="visible"}};disabled=function(i){if(i!="selectDate"){a.addClass("cancel").find("input").prop("disabled",true)}if(i!="selectPage"){f.addClass("cancel").find("input").prop("disabled",true)}if(i!="currentPage"){g.closest("div").addClass("cancel");g.prop("disabled",true)}};clear=function(){a.removeClass("cancel").find("input").removeProp("disabled");f.removeClass("cancel").find("input").removeProp("disabled");g.closest("div").removeClass("cancel");g.removeProp("disabled");e=d=null;g[0].checked=false;c.effectiveDate=c.endDate=null;c.startPage=c.finishPage=null}}]);